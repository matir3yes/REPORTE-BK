<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>BLACK KING - Intelligence Engineering Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Inter:wght@400;600;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #05070a; color: #e2e8f0; margin: 0; padding: 0; }
        .font-brand { font-family: 'Montserrat', sans-serif; }
        
        .compact-header { 
            background: rgba(15, 23, 42, 0.9); 
            border: 1px solid #1e293b; 
            border-radius: 8px; 
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        .bk-card { 
            background: rgba(15, 23, 42, 0.8); 
            border: 1px solid #1e293b; 
            border-radius: 12px; 
            margin-bottom: 1rem; 
            padding: 1.2rem;
            border-left: 4px solid #f59e0b;
        }

        .card-ok { border-left: 4px solid #10b981 !important; background: rgba(16, 185, 129, 0.05); }

        .dtc-badge { 
            background: #f59e0b; 
            color: black; 
            font-weight: 900; 
            padding: 2px 10px; 
            border-radius: 4px; 
            font-family: 'Montserrat', sans-serif; 
            font-size: 0.9rem;
        }

        .ok-badge { 
            background: #10b981; 
            color: white; 
            font-weight: 900; 
            padding: 2px 10px; 
            border-radius: 4px; 
            font-family: 'Montserrat', sans-serif; 
            font-size: 0.8rem;
        }

        .info-label { text-transform: uppercase; font-size: 8px; font-weight: 900; color: #f59e0b; letter-spacing: 1.5px; margin-bottom: 2px; }
        .info-value { background: transparent; border-bottom: 1px solid rgba(255,255,255,0.1); width: 100%; color: white; font-size: 13px; outline: none; padding-bottom: 2px; font-weight: 600; }
        
        .editable-text { cursor: text; padding: 4px; border-radius: 4px; transition: all 0.2s; border: 1px solid transparent; line-height: 1.5; }
        .editable-text:hover { background: rgba(245, 158, 11, 0.05); border: 1px dashed rgba(245, 158, 11, 0.3); }
        .editable-text:focus { background: rgba(245, 158, 11, 0.1); border: 1px solid #f59e0b; outline: none; }

        .disclaimer-box {
            border: 1px solid rgba(245, 158, 11, 0.2);
            background: rgba(15, 23, 42, 0.5);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 2rem;
        }

        @media print { 
            @page { size: auto; margin: 10mm; }
            .no-print { display: none !important; } 
            body { background: white !important; color: black !important; } 
            .compact-header { background: #f8fafc !important; border: 1px solid #e2e8f0 !important; }
            .bk-card { background: white !important; border: 1px solid #e2e8f0 !important; border-left: 4px solid #f59e0b !important; page-break-inside: avoid; } 
            .card-ok { border-left: 4px solid #10b981 !important; background: white !important; }
            .info-label { color: #64748b !important; } 
            .info-value { color: black !important; border-bottom: 1px solid #e2e8f0 !important; } 
            .dtc-badge { background: #f59e0b !important; -webkit-print-color-adjust: exact; color: black !important; } 
            .ok-badge { background: #10b981 !important; -webkit-print-color-adjust: exact; color: white !important; border: none !important; }
            .editable-text { border: none !important; color: #1e293b !important; font-size: 11px; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center border-b-2 border-amber-500 pb-6 mb-6">
            <div>
                <h1 class="font-brand text-4xl italic font-black text-white tracking-tighter uppercase">BLACK KING</h1>
                <p class="text-amber-500 font-bold text-[10px] tracking-[5px] uppercase mt-1">Ingenier√≠a Automotriz Aplicada</p>
            </div>
            <div class="no-print">
                <input type="file" id="pdf-file" class="hidden" accept="application/pdf">
                <button onclick="document.getElementById('pdf-file').click()" class="bg-white text-black font-black px-6 py-2 rounded hover:bg-amber-500 transition-all text-[10px] uppercase shadow-lg">Cargar Escaneo LAUNCH</button>
            </div>
        </header>

        <section class="compact-header">
            <div><p class="info-label">Veh√≠culo</p><input type="text" id="v-car" class="info-value"></div>
            <div><p class="info-label">Patente</p><input type="text" id="v-plate" class="info-value uppercase"></div>
            <div><p class="info-label">A√±o</p><input type="text" id="v-year" class="info-value"></div>
            <div><p class="info-label">KM</p><input type="text" id="v-km" class="info-value"></div>
            <div class="md:col-span-2"><p class="info-label">VIN / Chasis</p><input type="text" id="v-vin" class="info-value uppercase"></div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 no-print mb-8">
            <section class="bk-card border-dashed border-amber-500/40 py-4 mb-0">
                <h2 class="text-[9px] font-black text-amber-500 mb-4 tracking-[2px] uppercase">A√±adir DTC Manualmente</h2>
                <div class="flex flex-col gap-2">
                    <input type="text" id="manual-code" class="bg-white/5 border border-white/10 rounded p-2 text-xs uppercase text-white" placeholder="Ej: P0300">
                    <input type="text" id="manual-desc" class="bg-white/5 border border-white/10 rounded p-2 text-xs text-white" placeholder="Falla detectada...">
                    <button onclick="agregarDTCManual()" class="bg-amber-500 text-black font-black py-2 rounded text-[10px] uppercase mt-2">A√±adir Falla</button>
                </div>
            </section>

            <section class="bk-card border-dashed border-green-500/40 py-4 mb-0" style="border-left-color: #10b981;">
                <h2 class="text-[9px] font-black text-green-500 mb-4 tracking-[2px] uppercase">A√±adir Sistema OK Manualmente</h2>
                <div class="flex flex-col gap-2">
                    <input type="text" id="manual-ok-name" class="bg-white/5 border border-white/10 rounded p-2 text-xs text-white" placeholder="Ej: Engine Control Module (ECM)">
                    <div class="flex-1"></div>
                    <button onclick="agregarOKManual()" class="bg-green-500 text-white font-black py-2 rounded text-[10px] uppercase mt-auto">A√±adir M√≥dulo OK</button>
                </div>
            </section>
        </div>

        <div id="status" class="text-center py-10 opacity-20 uppercase text-[10px] tracking-widest no-print">Procese el reporte para visualizar resultados...</div>
        
        <div id="dtc-container" class="space-y-4 mb-8"></div>
        
        <div id="ok-section" class="hidden">
            <h2 class="text-[10px] font-black text-green-500 mb-4 tracking-[3px] uppercase border-b border-green-500/20 pb-2">Sistemas sin errores detectados (Estatus OK)</h2>
            <div id="ok-container" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
        </div>

        <div id="legal-disclaimer" class="hidden disclaimer-box">
            <p class="text-[10px] text-slate-400 uppercase leading-relaxed text-justify">
                <strong>Certificaci√≥n:</strong> Reporte mediante LAUNCH X-431 PRO V5, v√≠a <strong>OBD-II</strong> (On-Board Diagnostics - Diagn√≥stico de a Bordo) y revisi√≥n f√≠sica. Datos y <strong>DTC</strong> (Diagnostic Trouble Codes - C√≥digos de Falla) v√°lidos solo al momento de la prueba. Black King Automotriz no garantiza vida √∫til futura ni responde por fallas fortuitas, fatiga de materiales o desgaste posterior a la entrega.
            </p>
        </div>

        <footer id="footer" class="hidden mt-8 pt-6 border-t border-amber-500/20 text-center pb-12">
            <h3 class="font-brand font-black text-white text-xl uppercase tracking-widest">Mat√≠as Reyes Rosales</h3>
            <p class="text-[10px] text-amber-500 font-bold uppercase tracking-[3px]">Ingeniero en Maquinaria, Veh√≠culos Automotrices y Sistemas Electr√≥nicos</p>
        </footer>

        <button id="print-btn" onclick="window.print()" class="hidden fixed bottom-8 right-8 bg-amber-500 text-black font-black px-8 py-4 rounded-full shadow-2xl no-print hover:scale-110 transition-all uppercase text-[10px] tracking-[2px]">
            üñ®Ô∏è Generar PDF Final
        </button>
    </div>

    <script>
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

        document.getElementById('pdf-file').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function() {
                const typedarray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                let text = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(item => item.str).join(" ") + " \n ";
                }
                procesarTodo(text);
            };
            reader.readAsArrayBuffer(file);
        });

        function procesarTodo(text) {
            // Extracci√≥n de datos de cabecera
            const plate = text.match(/Matr√≠cula\s*[:\s]*([A-Z0-9]+)/i);
            const make = text.match(/Marca\s*[:\s]*([A-Z]+)/i);
            const model = text.match(/Modelo\s*[:\s]*([A-Z0-9]+)/i);
            const year = text.match(/A√±o\s*[:\s]*(\d{4})/i);
            const km = text.match(/Kilometraje\s*[:\s]*([\d\s]+km)/i);
            const vin = text.match(/[A-HJ-NPR-Z0-9]{17}/);

            if(plate) document.getElementById('v-plate').value = plate[1];
            if(make && model) document.getElementById('v-car').value = `${make[1]} ${model[1]}`;
            if(year) document.getElementById('v-year').value = year[1];
            if(km) document.getElementById('v-km').value = km[1];
            if(vin) document.getElementById('v-vin').value = vin[0];

            // Detecci√≥n Autom√°tica de OKs
            const okPart = text.split(/sistemas son OK:|systems are OK:/i)[1];
            if(okPart) {
                const systems = okPart.split(/\d+\./).slice(1);
                systems.forEach(s => {
                    const name = s.split("Pasado")[0].split("Viejo")[0].split("\n")[0].trim();
                    if(name.length > 2 && name.length < 60) crearTarjetaOK(name);
                });
            }

            // Detecci√≥n Autom√°tica de DTCs
            const dtcRegex = /([PCBU][0-9]{4,5})/gi;
            let found = [];
            let match;
            while ((match = dtcRegex.exec(text)) !== null) {
                const code = match[1].toUpperCase();
                let desc = text.substring(match.index + code.length, match.index + 120)
                               .split(/Pasado|Viejo|DTC|---/)[0].replace(/[:.\d]/g, "").trim();
                if(desc.length > 3) found.push({ code, desc });
            }

            const dtcContainer = document.getElementById('dtc-container');
            dtcContainer.innerHTML = "";
            const unique = [...new Map(found.map(item => [item.code, item])).values()];
            unique.forEach(dtc => crearTarjetaDTC(dtc.code, dtc.desc));

            activarReporte();
        }

        function agregarDTCManual() {
            const code = document.getElementById('manual-code').value.trim().toUpperCase();
            const desc = document.getElementById('manual-desc').value.trim();
            if (!code || !desc) return;
            activarReporte();
            crearTarjetaDTC(code, desc);
            document.getElementById('manual-code').value = "";
            document.getElementById('manual-desc').value = "";
        }

        function agregarOKManual() {
            const name = document.getElementById('manual-ok-name').value.trim();
            if (!name) return;
            activarReporte();
            crearTarjetaOK(name);
            document.getElementById('manual-ok-name').value = "";
        }

        function activarReporte() {
            document.getElementById('status').classList.add('hidden');
            document.getElementById('footer').classList.remove('hidden');
            document.getElementById('legal-disclaimer').classList.remove('hidden');
            document.getElementById('print-btn').classList.remove('hidden');
        }

        function crearTarjetaDTC(code, desc) {
            const container = document.getElementById('dtc-container');
            const card = document.createElement('div');
            card.className = "bk-card";
            card.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                    <div class="md:col-span-4">
                        <span class="dtc-badge mb-2">${code}</span>
                        <h4 contenteditable="true" class="text-white font-extrabold text-[10px] uppercase leading-tight editable-text">${desc}</h4>
                    </div>
                    <div class="md:col-span-8 grid grid-cols-1 gap-4 border-l border-white/5 pl-4">
                        <div>
                            <p class="info-label">An√°lisis T√©cnico</p>
                            <div contenteditable="true" class="editable-text text-[11px] text-slate-400 italic">[BK]: Falla en "${desc}". Evaluar par√°metros en tiempo real.</div>
                        </div>
                        <div class="bg-amber-500/5 p-2 rounded">
                            <p class="info-label text-green-500">Nota Propietario</p>
                            <div contenteditable="true" class="editable-text text-[11px] text-white font-bold italic">Irregularidad detectada en "${desc}". Requiere atenci√≥n.</div>
                        </div>
                    </div>
                </div>`;
            container.appendChild(card);
        }

        function crearTarjetaOK(name) {
            const okSection = document.getElementById('ok-section');
            const okContainer = document.getElementById('ok-container');
            okSection.classList.remove('hidden');
            
            const div = document.createElement('div');
            div.className = "bk-card card-ok py-2 px-4 flex justify-between items-center";
            div.innerHTML = `
                <span contenteditable="true" class="text-[10px] uppercase font-bold text-slate-300 editable-text flex-1">${name}</span>
                <span class="ok-badge ml-4">ESTADO OK</span>
            `;
            okContainer.appendChild(div);
        }
    </script>
</body>
</html>